---
marp: true
paginate: true
math: mathjax

style: |
    section.title {
        --title-height: 130px;
        --subtitle-height: 70px;

        font-family: 'Meiryo UI';
        overflow: visible;
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 1fr var(--title-height) var(--subtitle-height) 1fr;
        grid-template-areas: "." "title" "subtitle" ".";
    }

    section.title h2 {
        margin: 0;
        padding: 0;
        text-align: center;
        height: var(--area-height);
        line-height: var(--area-height);
        font-size: calc(var(--area-height) * 0.7);

        border: 1px dashed gray; /* debug */
    }

    section.title h1 {
        color: #0445FF;
        font-weight: bold;
        font-family: 'Meiryo UI';

    }

    section.title h2 {
        grid-area: subtitle;
        --area-height: var(--subtitle-height);
    }

    section {
        justify-content: start;
        font-family: 'Meiryo UI'
    }

    .title-slide {
    display: grid;
    place-items: center; /* ä¸­å¤®æƒãˆ */
    height: 100vh; /* ã‚¹ãƒ©ã‚¤ãƒ‰å…¨ä½“ã®é«˜ã• */
    }
---
---
---
---
---
---
---
---
---
<br>
<br>
<br>
<br>
<br>
<br>
<br>

# STEP 1


---
# VAEï¼ˆå¤‰åˆ†ã‚ªãƒ¼ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼ï¼‰ã«ãŠã‘ã‚‹ELBO
ç‹¬ç«‹ã®ã‚¬ã‚¦ã‚¹åˆ†å¸ƒ $x,y$ ã¨ã€ãã®å’Œ $z$ ã‚’è€ƒãˆã‚‹ã¨ã€ï¼ˆå¤‰åˆ†ã‚ªãƒ¼ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼ï¼‰ã«ãŠã„ã¦ã€VAE ã® $ELBO$ ã¯æ¬¡å¼ã€

$$
\begin{align}
    ELBO(y;\theta, \phi) 

    &= \int q_{\phi}(z \mid x) \log \frac{p_{\theta}(x \mid z)}{q_{\phi}(z \mid x)} dz\\

    &= \mathbb{E}_{q_{\phi}(z \mid x)} \left[ \log \frac{p_{\theta}(x \mid z)}{q_{\phi}(z \mid x)} \right]
    \tag{1}
\end{align}
$$
ã¨ãªã‚‹ã€‚

---
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®ELBO
å‰ã‚¹ãƒ©ã‚¤ãƒ‰ã® $(1)$ å¼ã‹ã‚‰æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã«ã™ã‚‹ãŸã‚ã«ã€

- ç”»åƒ $x$ ã‚’ã€ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã‚’è€ƒæ…®ã—ã¦ $x_{0}$ 
- æ½œåœ¨å¤‰æ•° $z$ ã‚’ $x_{1}, x_{2}, \cdots, x_{T}$ ã¸å¤‰æ›´
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\phi$ ã‚’å‰Šé™¤

ã“ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã¨æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã® $ELBO$ ã¯ã€
$$
\begin{align}
    ELBO(x_{0};\theta)
    
    = \mathbb{E}_{q_{\phi}(x_{1}, x_{2}, \cdots, x_{T} \mid x_0)} \left[ \log \frac{p_{\theta}(x_{0}, x_{1}, \cdots, x_{T})}{q_{\phi}(z \mid x)} \right]
    \tag{2}
\end{align}
$$
ã¨ãªã‚Šã€$x_{0}, x_{1}, \cdots, x_{T}$ ã‚’ $x_{0:T}$ ã¨ã™ã‚‹ã¨ã€ $(2)$ å¼ã¯æ¬¡å¼ã§è¡¨ã›ã‚‹ã€‚
$$
\begin{align}
    ELBO(x_{0};\theta)
    
    = \mathbb{E}_{q(x_1:T \mid x_0)} \left[ \log \frac{p_\theta(x_{0:T})}{p_\theta(x_{1:T} \mid x_0)} \right]
    \tag{3}
\end{align}
$$

---
# ELBOã®å¼å±•é–‹
ã“ã“ã§ã¯ELBOã®å¼å±•é–‹ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ELBOã®å¼(8.2)ã«å‡ºã¦ãã‚‹å¼ã® $p_0(x_{0:T})$ ã§ã™ã€‚ã“ã‚Œã¯é€£ç¶šå‹ç¢ºç‡å¤‰æ•°ãƒãƒ«ã‚³ãƒ•é€£é–ã«ã‚ˆã‚Šæ¬¡ã®å¼ã§è¡¨ã•ã‚Œã¾ã™ã€‚
$$
\begin{align}
    p_\theta(x_{0:T}) 

    &= p_\theta(x_\theta \mid x_1) p_\theta(c_1 \mid x_1) \ldots p_\theta(x_{T-1} \mid x_T) p(x_T)\\

    &= p(x_T) \prod_{t=1}^T p_\theta(x_{t-1} \mid x_t)\tag{4}
\end{align}
$$
ã“ã“ã§æœ€çµ‚æ™‚åˆ»ã® $p(x_T)$ ã¯ã€å®Œå…¨ãªã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚º $N(x_T; 0,1)$ ã‚’è¡¨ã—ã¾ã™ã€‚
æ¬¡ã« $q(x_{1:T} \mid x_0)$ ã‚’ä¹—æ³•å®šç†ã¨ãƒãƒ«ã‚³ãƒ•æ€§ã‚ˆã‚Šæ¬¡å¼ã§è¡¨ã•ã‚Œã¾ã™ã€‚
$$
q(x_{1:T} \mid x_0) = \prod_{t=1}^T q(x_t \mid x_{t-1})\tag{5}
$$

---
# ELBOã®å¼å±•é–‹ -2
å…ˆã»ã©ã®å¼ã‚ˆã‚Šã€ELBOã¯æ¬¡å¼ã§è¡¨ã•ã‚Œã¾ã™ã€‚
$$
\begin{align}
    \text{ELBO}(q) 

    &= \mathbb{E}_{q(x_1:T \mid x_0)} \left[ \log \frac{p_\theta(x_{0:T})}{p_\theta(x_{1:T} \mid x_0)} \right]\\

    &= \mathbb{E}_{q(x_1:T \mid x_0)} \left[ \log \frac{p(x_T) \prod_{t=1}^T p_\theta(x_{t-1} \mid x_t)}{\prod_{t=1}^T q(x_t \mid x_{t-1})} \right]\\
\end{align}
$$
$$
\begin{align}
    &= \mathbb{E}_{q(x_1:T \mid x_0)} \left[ \log \prod_{t=1}^T p_\theta(x_{t-1} \mid x_t) + \boxed{\log \frac{p(x_T)}{\prod_{t=1}^T q(x_t \mid x_{t-1})} } \right]\tag{6}
\end{align}
$$

ã“ã“ã§ã€ELBOã‚’0ã«é–¢ã—ã¦æœ€é©åŒ–ã™ã‚‹ã“ã¨ãŒç›®çš„ãªã®ã§ã€ELBOã®ä¸­ã§0ã‚’å«ã¾ãªã„ã€ä¸Šè¨˜ã®â–¡ã§å›²ã£ãŸé …ã¯ç„¡è¦–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---
# ELBOã®å¼å±•é–‹ -3
$J(\theta)$ ã¨ã„ã†å¼ã§ç›®çš„é–¢æ•°(= æœ€å¤§åŒ–ã™ã‚‹å¯¾è±¡)ã‚’è¡¨ã™ã¨ã€
$$
\begin{align}
J(\theta) 

&= \mathbb{E}_{q(x{1:T} \mid x_0)} \left[ \log \prod_{t=1}^T p_\theta(x_{t-1} \mid x_t) \right]\\

&= \mathbb{E}_{q(x{1:T} \mid x_0)} \left[ \sum_{t=1}^T \log p_\theta(x_{t-1} \mid x_t) \right]
\tag{7}
\end{align}
$$

ã“ã“ã§ã€ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã®ã‚µãƒ³ãƒ—ãƒ«ã‚µã‚¤ã‚ºã‚’1ã¨ã™ã‚‹ã¨ã€

$$
\begin{align}
x_{1: T} 

&\sim q\left(x_{1: T} \mid x_{0}\right) \tag{8}\\

J(\theta) 

&\approx \sum_{t=1}^{T} \log p_{\theta}\left(x_{t-1} \mid x_{t}\right)\tag{9}
\end{align}
$$

---
# ç›®çš„é–¢æ•°ã®å°å‡º
ã“ã“ã§ã€å…ƒã®ãƒ‡ãƒ¼ã‚¿ $\boldsymbol{x}_{0}$ ã‹ã‚‰æ‹¡æ•£ã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‹å§‹ã—ã€$\boldsymbol{x}_{1:T}$ã‚’ç”Ÿæˆã€‚ãã® $\boldsymbol{x}_{1:T}$ ã‚’ç”¨ã„ã¦å„æ™‚åˆ»ã«ãŠã‘ã‚‹$\log p_{\theta}(\boldsymbol{x}_{t-1} | \boldsymbol{x}_{t})$ã‚’è¨ˆç®—ã™ã‚‹ã¨ä»®å®šã™ã‚‹ã€‚

$$
\begin{align}
\hat{x}_{t-1} 
= \operatorname{NeuralNet}\left(\boldsymbol{x}_{t}, t ; \boldsymbol{\theta}\right) \tag{10}\\
p_{\theta}\left(x_{t-1} \mid \boldsymbol{x}_{t}\right) = \mathcal{N}\left(\boldsymbol{x}_{t-1} ; \hat{\boldsymbol{x}}_{t-1}, \mathbf{I}\right)\tag{11}
\end{align}
$$
ã‚ˆã‚Šã€ç›®çš„é–¢æ•° $J(\theta)$ ã¯ã€
$$
\begin{align}
J(\theta) 
& \approx \sum_{t=1}^{T} \log p_{\theta}\left(x_{t-1} \mid x_{t}\right) \\
& = \sum_{t=1}^{T} \log \mathcal{N}\left(x_{t-1} ; \hat{x}_{t-1}, \mathrm{I}\right) \\
\end{align}
$$

---
# ç›®çš„é–¢æ•°ã®å°å‡º -2
$$
\begin{align}
& = \sum_{t=0}^{T-1} \log \mathcal{N}\left(x_{t} ; \hat{x}_{t}, \mathbf{I}\right) \quad \text{ï¼ˆ} t \text{ ã®èå§‹ç•ªå·ã‚’å¤‰æ›´ï¼‰} \\

& = \sum_{t=0}^{T-1} \log \frac{1}{\sqrt{(2 \pi)^{D}|\mathbf{I}|}} \exp \left\{ -\frac{1}{2}\left(x_{t}-\hat{x}_{t}\right)^{\top} \mathbf{I}^{-1} \left(x_{t}-\hat{x}_{t}\right) \right\}  \text{ï¼ˆ} t \text{ æ­£è¦åˆ†å¸ƒã®å¼ã‚’ä»£å…¥}\text{ï¼‰}  \\

& = \sum_{t=0}^{T-1} \left( -\frac{1}{2}\left(x_{t}-\hat{x}_{t}\right)^{\top}\left(x_{t}-\hat{x}_{t}\right) + \log \frac{1}{\sqrt{(2 \pi)^{D}}} \right) \quad \left( |\mathbf{I}|=1, \quad \mathbf{I}^{-1}=\mathrm{I} \right) \\

& = -\frac{1}{2} \sum_{t=0}^{T-1} \left(x_{t}-\hat{x}_{t}\right)^{\top}\left(x_{t}-\hat{x}_{t}\right) + \boxed{T \log \frac{1}{\sqrt{(2 \pi)^{D}}} }\text{ï¼ˆå®šæ•°ï¼‰} \\

& = -\frac{1}{2} \sum_{t=0}^{T-1} \left|\left| x_{t}-\hat{x}_{t}\right|\right| ^{2} \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad(12)
\end{align}
$$

---
# ç›®çš„é–¢æ•°ã®å°å‡º -3
ã—ãŸãŒã£ã¦ã€ã“ã“ã¾ã§ã®çµæœã‹ã‚‰ã€ç›®çš„é–¢æ•° $J(\theta) $ ã¯æ¬¡ã«ç¤ºã™ã‚¹ãƒ†ãƒƒãƒ—ã§æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

1. æ‹¡æ•£éç¨‹ã«ã‚ˆã‚Š $T$ å€‹ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚’è¡Œã†
2. ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ $T$ å›é©ç”¨ã—ã¦ãƒã‚¤ã‚ºã‚’é™¤å»
3. å„æ™‚åˆ»ã«ãŠã‘ã‚‹2ä¹—èª¤å·® $||x_{t}-\hat{x}_{t}||^{2}$ ã‚’æ±‚ã‚ã‚‹

ã—ã‹ã—ãªãŒã‚‰ã€ä¸Šè¨˜ã® 1 ~ 3ã®é †ã§æ±‚ã‚ã‚‹ã¨ã€è¨ˆç®—ãŒã™ã”ãå¤§å¤‰â€¦ã€‚

æ¬¡ã‚¹ãƒ©ã‚¤ãƒ‰ä»¥é™ã‹ã‚‰ã€ã“ã®è¨ˆç®—ã‚’è¿‘ä¼¼ã§è»½ãã™ã‚‹æ‰‹æ³•ã‚’è€ƒãˆã‚‹ã€‚

---
<br>
<br>
<br>
<br>
<br>
<br>
<br>

# STEP 2

---
# ELBOã®è¿‘ä¼¼
$(7)$ å¼ã‹ã‚‰ã€
$$
\begin{align}
J(\theta) & =\mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_{0}\right)}\left[\sum_{t=1}^{T} \log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\right] \\

& =\sum_{t=1}^{T} \mathbb{E}_{q\left(\boldsymbol{x}_{1: T} \mid \boldsymbol{x}_{0}\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\right] \text{ï¼ˆæœŸå¾…å€¤ã®ç·šå½¢æ€§ï¼‰} (13)\\

& =\sum_{t=1}^{T} \mathbb{E}_{q\left(\boldsymbol{x}_{t-1}, \boldsymbol{x}_{t} \mid \boldsymbol{x}_{0}\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\right]
\text{ï¼ˆé–¢é€£ã™ã‚‹å¤‰æ•°ã®æœŸå¾…å€¤ï¼‰}(14)
\end{align}
$$

---
# ä¸€æ§˜åˆ†å¸ƒã®æœŸå¾…å€¤
$1$ ã‹ã‚‰ $T$ ã¾ã§ã®ä¸€æ§˜åˆ†å¸ƒã«ãŠã‘ã‚‹ç¢ºç‡åˆ†å¸ƒã‚’ $u(t)$ ã¨ã™ã‚‹ã¨ã€
$$
\begin{align}
    \mathbb{E}_{u(t)}[f(t)]
    
    &= \sum_{t=1}^{T} u(t)f(t)\\
    
    &= \sum_{t=1}^{T} \frac{1}{T} f(t)\\

    &= \frac{1}{T}\sum_{t=1}^{T} f(t)\\

    \Leftrightarrow \sum_{t=1}^{T} f(t) &= T\ \mathbb{E}_{u(t)}[f(t)] \tag{15}
\end{align}
$$

---
# $ELBO$ã®è¿‘ä¼¼
$$
\begin{align}
J(\theta) 

& =\sum_{t=1}^{T} \mathbb{E}_{q\left(\boldsymbol{x}_{t-1}, \boldsymbol{x}_{t} \mid \boldsymbol{x}_{0}\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\right] \\

&= T \ \mathbb{E}_{u(t)}[\mathbb{E}_{q\left(\boldsymbol{x}_{t-1}, \boldsymbol{x}_{t} \mid \boldsymbol{x}_{0}\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\right]] \tag{16}
\end{align}
$$

ã“ã®å¼ã‚’ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã«ã‚ˆã£ã¦è¿‘ä¼¼è¨ˆç®—ã™ã‚‹ã¨ã€

$$
\begin{align}
J(\theta) 

& \approx T\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\tag{17}
\end{align}
$$
ã¨ãªã‚‹ã€‚ã“ã“ã§ $(12)$ å¼ã§å°å‡ºã—ãŸã‚ˆã†ã«ã€ã‚¬ã‚¦ã‚¹åˆ†å¸ƒã®å¯¾æ•°å°¤åº¦ã¯2ä¹—èª¤å·®ã«å¸°ç€ã™ã‚‹ãŸã‚ã€
$$
\begin{align}
J(\theta) 
& \approx -\frac{T}{2} \left|\left| x_{t-1}-\hat{x}_{t-1}\right|\right| ^{2} \tag{18}
\end{align}
$$
ã¨ãªã‚‹ã€ã“ã‚ŒãŒæ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã«ãŠã‘ã‚‹ç›®çš„é–¢æ•°ï¼ˆ$ELBO$ï¼‰ã®è¿‘ä¼¼å¼ã§ã‚ã‚‹ã€‚

---
# $ELBO$ã®è¿‘ä¼¼ -2
ã—ãŸãŒã£ã¦ã€ã“ã“ã¾ã§ã®çµæœã‹ã‚‰ã€ç›®çš„é–¢æ•° $J(\theta)$ ã¯è¿‘ä¼¼ã«ã‚ˆã£ã¦ã€æ¬¡ã«ç¤ºã™ã‚¹ãƒ†ãƒƒãƒ—ã§æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

1. ä¸€æ§˜åˆ†å¸ƒ $U \{1, T \}$ ã‹ã‚‰æ™‚åˆ» $t$ ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
2. $q(x_{t-1},x_0)$ ã‹ã‚‰ $x_{t-1}$ ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã€æ¬¡ã«$q(x_{t},x_{t-1})$ ã‹ã‚‰ $x_{t}$ ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã™ã‚‹
3. ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã« $x_{t}$ ã‚’å…¥åŠ›ã—ã¦ $\hat{x}_{t-1}$ ã‚’å‡ºåŠ›ã™ã‚‹
4. 2ä¹—èª¤å·® $||x_{t-1}-\hat{x}_{t-1}||^{2}$ ã‚’æ±‚ã‚ã‚‹



---
# $q(x_t \mid x_0)$ ã®å°å‡º
ã“ã“ã§ã€å…¥åŠ›ç”»åƒã‹ã‚‰ã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚ºã‚’é€£ç¶šã—ã¦ä»˜ä¸ã™ã‚‹å‡¦ç†ã«ã¤ã„ã¦è€ƒãˆã‚‹ã€‚
ç‹¬ç«‹ã®ã‚¬ã‚¦ã‚¹åˆ†å¸ƒ $x,y$ ã¨ã€ãã®å’Œ $z$ ã‚’è€ƒãˆæ¬¡å¼ã§å®šç¾©ã™ã‚‹ã€‚
$$
\begin{align}
x
&\sim \mathcal{N}(\mu_x, \sigma^2_x) \tag{19}\\
y
&\sim \mathcal{N}(\mu_y, \sigma^2_y) \tag{20}\\
z
&= x+y \tag{21}
\end{align}
$$

ã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚ºã®å’Œã¯ã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚ºã§ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€$z$ ã¯1ã¤ã®ã‚¬ã‚¦ã‚¹åˆ†å¸ƒã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦è€ƒãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã®æ€§è³ªã‚’åˆ©ç”¨ã™ã‚‹ã¨æ¬¡å¼ã€

$$
\begin{align}
z
&\sim \mathcal{N}(\mu_x+\mu_y, \sigma^2_x+\sigma^2_y) \tag{21}\\  
\end{align}
$$

ã§è¡¨ã™ã“ã¨ãŒã§ãã‚‹ã€‚

---
# ã‚¬ã‚¦ã‚¹éç¨‹ã«ãŠã‘ã‚‹ãƒã‚¤ã‚ºã®å®šç¾©
ã“ã“ã§ã€ä»˜ä¸ã™ã‚‹ã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚ºã«ã¤ã„ã¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã€‚å…·ä½“çš„ã«ã¯ã€ä»˜ä¸ã™ã‚‹ã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚ºã«ã¤ã„ã¦æ™‚é–“çµŒéã¨ã¨ã‚‚ã«ã€æ¬¡ç¬¬ã«å°ã•ããªã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ã€æ‹¡æ•£éç¨‹ã«ãŠã‘ã‚‹ã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚º $q(x_t \mid x_t-1)$ ã¯æ¬¡å¼ã€

$$
\begin{align}
q(x_t \mid x_t-1)
&= \mathcal{N}(x_t\sqrt{1-\beta_t}x_t -1, \beta_t \boldsymbol{I}) \tag{22}\\  
\end{align}
$$

ã§è¡¨ã™ã“ã¨ãŒã§ãã‚‹ã€‚ãŸã ã—ã€$\boldsymbol{I}$ ã‚’å˜ä½è¡Œåˆ—ã€$\beta_t$ ã¯ãƒ¦ãƒ¼ã‚¶ãŒä»»æ„ã§è¨­å®šã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã€ $\beta_{1},\beta_{2},\cdots,\beta_{T}$ ã¨ã™ã‚‹ã€‚ä¾‹ãˆã°ã€$\beta_1$ ã‚’ $0$ ã¨ã—ã¦ã€ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã« $0 \sim 0.01$ ã«å¤‰åŒ–ã™ã‚‹é–¢æ•°ã®ã‚ˆã†ã«è¨­è¨ˆã§ãã‚‹ã€‚ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©è‡ªä½“ã¯ã‚³ã‚µã‚¤ãƒ³æ³¢ã€
ã‚·ã‚°ãƒ¢ã‚¤ãƒ‰ãªã©æ§˜ã€…å­˜åœ¨ã™ã‚‹ã®ã§å‰²æ„›ã€‚
ã¾ãŸã€$(22)$ å¼ã¯é•·ã„ã®ã§ã€$\alpha_t = 1 - \beta_t$ ã¨ã—ã¦ã€æ¬¡å¼ã§ç¤ºã™ã“ã¨ã«ã™ã‚‹ã€‚

$$
\begin{align}
q(x_t \mid x_t-1)
&= \mathcal{N}(x_t\sqrt{\alpha_t}x_t -1, (1-\alpha_t) \boldsymbol{I}) \tag{23}\\  
\end{align}
$$

----
# $q(x_t \mid x_0)$ ã®å°å‡º -2
ã“ã“ã§ã€$\text{VAE}$ åŒæ§˜ã«å¤‰æ•°å¤‰æ›ï¼ˆå†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ï¼‰ãƒˆãƒªãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦

$$
\begin{align}
\varepsilon_t
&\sim \mathcal{N}(0,\boldsymbol{I}) \tag{24}\\
x_{t}
&=\sqrt{\alpha_{t}} x_{t-1}+\sqrt{1-\alpha_{t} }\varepsilon_{t}
\tag{25}
\end{align}
$$
ã¨è¡¨ã™ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã“ã§ã€$t$ ã« $t-1$ ã‚’ä»£å…¥ã—ã¦ã€
$$
\begin{align}
\varepsilon_{t-1}
&\sim \mathcal{N}(0,\boldsymbol{I}) \tag{26}\\
x_{t-1}
&=\sqrt{\alpha_{t-1}} x_{t-2}+\sqrt{1-\alpha_{t-1} }\varepsilon_{t-1}\tag{27}
\end{align}
$$
ãã—ã¦ã€ã“ã‚Œã‚‰ã® $(24)\sim(27)$ å¼ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€æ¬¡å¼ãŒæ±‚ã¾ã‚‹ã€‚

---
# $q(x_t \mid x_0)$ ã®å°å‡º -3
$$
\begin{align}
x_{t} 
& =\sqrt{\alpha_{t}} x_{t-1}+\sqrt{1-\alpha_{t}} \varepsilon_{t} \\
& =\sqrt{\alpha_{t}}\left(\sqrt{\alpha_{t-1}} x_{t-2}+\sqrt{1-\alpha_{t-1}} \varepsilon_{t-1}\right)+\sqrt{1-\alpha_{t}} \varepsilon_{t} \\
& =\sqrt{\alpha_{t} \alpha_{t-1}} x_{t-2}+ \boxed{\sqrt{\alpha_{t}-\alpha_{t} \alpha_{t-1}} \varepsilon_{t-1}+\sqrt{1-\alpha_{t}} \varepsilon_{t}}\tag{28}
\end{align}
$$

ã“ã“ã§ãŒã‚¬ã‚¦ã‚¹ãƒã‚¤ã‚ºã®å’Œã®æ€§è³ªã‚ˆã‚Šã€$(28)$ å¼ã«ãŠã‘ã‚‹â–¡ã®éƒ¨åˆ†ã¯ã€1ã¤ã®æ­£è¦åˆ†å¸ƒã§è¡¨ã™ã“ã¨ãŒ
ã§ãã‚‹ãŸã‚ã€

$$
\begin{align}
\varepsilon
&\sim \mathcal{N}(0,\boldsymbol{I}) \tag{29}\\
x_{t}
&=\sqrt{\alpha_{t} \alpha_{t-1}} x_{t-2}+\sqrt{1-\alpha_{t} \alpha_{t-1} }\varepsilon\tag{30}
\end{align}
$$

ã¨ãªã‚‹ã€‚

---
# $q(x_t \mid x_0)$ ã®å°å‡º -4
å…ˆã»ã©ã®æ•°å¼å¤‰å½¢ã‚’ã€$x_{t-2}, x_{t-3}, x_{t-4} \cdots$ ã¨é€æ¬¡çš„ã«ç¹°ã‚Šè¿”ã™ã¨ã€æœ€çµ‚çš„ã«æ¬¡å¼ãŒå¾—ã‚‰ã‚Œã‚‹ã€‚
$$
\begin{align}
x_{t} & =\sqrt{\alpha_{t} \alpha_{t-1} \cdots \alpha_{1}} x_{0}+\sqrt{1-\alpha_{t} \alpha_{t-1} \cdots \alpha_{1}} \varepsilon \\
& =\sqrt{\bar{\alpha}_{t}} x_{0} + \sqrt{1-\bar{\alpha}_{t}} \varepsilon \tag{31}
\end{align}
$$

ãŸã ã—ã€$\bar{\alpha}_t$ ã‚’ $\alpha_{t} \alpha_{t-1} \cdots \alpha_{1}$ ã¨ã™ã‚‹ã€‚

ã‚ˆã£ã¦ã€$q\left(x_{t} \mid x_{0}\right)$ ã¯

$$
\begin{align}
q\left(x_{t} \mid x_{0}\right)
=\mathcal{N}\left(x_{t} ; \sqrt{\bar{\alpha}_{t}} x_{0},\left(1-\bar{\alpha}_{t}\right) \mathbf{I}\right) \tag{32}
\end{align}
$$

ã¨ãªã‚‹ã€‚

---
<br>
<br>
<br>
<br>
<br>
<br>
<br>

# STEP 3

---
# $ELBO$ã®è¿‘ä¼¼ -3
$(16)$ ã‹ã‚‰ã€
$$
\begin{align}
J(\theta) 

& =\sum_{t=1}^{T} \mathbb{E}_{q\left(\boldsymbol{x}_{t-1}, \boldsymbol{x}_{t} \mid \boldsymbol{x}_{0}\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\right] \\

&= T \quad \mathbb{E}_{u(t)}[\mathbb{E}_{q\left(\boldsymbol{x}_{t-1}, \boldsymbol{x}_{t} \mid \boldsymbol{x}_{0}\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\right]] \tag{16}
\end{align}
$$

ã‚’å¾—ãŸã€‚
ã“ã“ã§ã€$\mathbb{E}_{q\left(\boldsymbol{x}_{t-1}, \boldsymbol{x}_{t} \mid \boldsymbol{x}_{0}\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)\right]$ ã‚’ $J_0$ ã¨å®šç¾©ã™ã‚‹ã€‚ã™ãªã‚ã¡ã€æ¬¡å¼ã€

$$
\begin{align}
J(\theta) 
&= T \ \mathbb{E}_{u(t)}\left[ J_0 \right] \tag{33}
\end{align}
$$

ã§å®šç¾©ã™ã‚‹ã€‚

---
# $ELBO$ã®è¿‘ä¼¼ -4
ã“ã“ã§ã€$(33)$ å¼ã«ãŠã„ã¦ã€æˆ‘ã€…ã¯ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ $\theta \left( = \left\{ \text{(å¹³å‡), (æ¨™æº–åå·®)} \right\} \right)$ ã«ã¤ã„ã¦æœ€é©åŒ–ã‚’è¡Œã£ã¦ã„ã‚‹ã€‚
ã¤ã¾ã‚Šã€$\theta$ ã«é–¢ä¿‚ãŒãªã‘ã‚Œã°ã€ä¾¿å®œã®ãŸã‚ã«é©å½“ãªæ•°ã‚’ $(33)$ å¼ã«åŠ ãˆã¦ã‚‚å•é¡Œãªã„ãŸã‚ã€ã“ã“ã§ã€æ¬¡å¼ã®ã‚ˆã†ã«å¤‰å½¢ã™ã‚‹ã€‚

$$
\begin{align}
\underset{\theta}{\arg \max } J_{0}

&= \underset{\theta}{\arg \max }\ \Bigg( J_{0}-\underbrace{\mathbb{E}_{q\left(x_{t-1}, x_{t} \mid x_{0}\right)}\left[\log q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}, \boldsymbol{x}_{0}\right)\right]}_{\text {å®šæ•° }}\Bigg)\\

&= \underset{\boldsymbol{\theta}}{\arg \max }\ \mathbb{E}_{q\left(\boldsymbol{x}_{t-1}, \boldsymbol{x}_{t} \mid \boldsymbol{x}_{0}\right)}\left[\log p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}\right)-\log q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}, \boldsymbol{x}_{0}\right)\right] \\

&=\underset{\boldsymbol{\theta}}{\arg \max }\ \underbrace{\mathbb{E}_{q\left(\boldsymbol{x}_{t-1}, x_{t} \mid x_{0}\right)}\left[\log \frac{p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid x_{t}\right)}{q\left(x_{t-1} \mid x_{t}, x_{0}\right)}\right]}_{J_{1}} \quad\quad\quad(34)\\
\end{align}
$$

---
# $ELBO$ã®è¿‘ä¼¼ -5
ã“ã“ã§ã¯ $(34)$ å¼ã®é …ã‚’ $J_{1}$ ã¨ã™ã‚‹ã€‚ 
$J_{0}$ ã¨ $J_{1}$ ã¯æœ€å¤§ã¨ãªã‚‹ $\boldsymbol{\theta}$ ãŒåŒã˜ãŸã‚ã€æ¬¡ã® $J_{1}$ ã‚’ä½¿ã£ãŸå¼ã‚’ç›®çš„é–¢æ•°ã«ã§ãã‚‹ã€‚

$$
\begin{align}
J(\theta)=T\ \mathbb{E}_{u(t)}\left[J_{1}\right]
\end{align}
$$

ç¶šã„ã¦ã€ $J_{1}$ ã‚’æ¬¡ã®ã‚ˆã†ã«å¼å±•é–‹ã—ã¾ã™ã€‚
$$
\begin{align}
J_{1} & =\int q\left(x_{t-1}, x_{t} \mid x_{0}\right) \log \frac{p_{\theta}\left(x_{t-1} \mid x_{t}\right)}{q\left(x_{t-1} \mid x_{t}, x_{0}\right)} d x_{t-1} d x_{t} \\
& =\int q\left(x_{t} \mid x_{0}\right) q\left(x_{t-1} \mid x_{t}, x_{0}\right) \log \frac{p_{\theta}\left(x_{t-1} \mid x_{t}\right)}{q\left(x_{t-1} \mid x_{t}, x_{0}\right)} d x_{t-1} d x_{t} \\
\end{align}
$$

---
# $ELBO$ã®è¿‘ä¼¼ -6
ï¼ˆç¶šãï¼‰
$$
\begin{align}
& =-\int q\left(x_{t} \mid x_{0}\right) \underbrace{\int q\left(x_{t-1} \mid x_{t}, x_{0}\right) \log \frac{q\left(x_{t-1} \mid x_{t}, x_{0}\right)}{p_{\theta}\left(x_{t-1} \mid x_{t}\right)} d x_{t-1}}_{\mathrm{KL} \text { ã‚¿ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ }} d x_{t} \\
& =-\mathbb{E}_{q\left(\boldsymbol{x}_{t} \mid x_{0}\right)}\left[D_{\mathrm{KL}}\left(q\left(x_{t-1} \mid x_{t}, x_{0}\right) \| p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid x_{t}\right)\right)\right]
\tag{35}
\end{align}
$$

<br>

ã“ã“ã§ã¯ç¢ºç‡ã®ä¹—æ³•å®šç†ã‚’ä½¿ã£ã¦å±•é–‹ã—ã¾ã™ã€‚æœ€çµ‚çš„ã«$J_{1}$ ã¯ã€ã€Œ$q\left(x_{t} \mid x_{0}\right)$ ã«é–¢ã™ã‚‹ $\text{KL}$ ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã®æœŸå¾…å€¤ã€ã¨ã—ã¦è¡¨ã•ã‚Œã‚‹ã€‚
$(35)$ å¼ã¯ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã‚’ä½¿ãˆã°ã€**$x_{t}$ ã®ã‚µãƒ³ãƒ–ãƒ« 1 ã¤ã ã‘ã§è¿‘ä¼¼ã§ãã¾ã™**ã€‚

---
# $ELBO$ã®è¿‘ä¼¼ -7
ã¾ãŸã€KLã‚¿ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã¯ï¼’ã¤ã®ç¢ºç‡åˆ†å¸ƒãŒç­‰ã—ã„ã¨ãã«æœ€å°å€¤ï¼ˆï¼0ï¼‰ã‚’å–ã‚‹ã€‚
$J_{1}$ ã¯ã€Œãƒã‚¤ãƒŠã‚¹ã®$\mathrm{KL}$ ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã€ãªã®ã§ã€2ã¤ã®ç¢ºç‡åˆ†å¸ƒãŒç­‰ã—ã„$\theta\left(x_{t-1} \mid x_{t}\right)=q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®ã¨ãã«æœ€å¤§ã«ãªã‚‹ã€‚

ã¤ã¾ã‚Šã€ã“ã“ã§ã®ç›®æ¨™ã¯ã€$p_{\theta}\left(x_{t-1} \mid x_{t}\right)$ ã‚’$q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã«ä¸€è‡´ã•ã›ã‚‹ã“ã¨ã§ã‚ã‚‹ã€‚
$q\left(x_{t}\right)$ ã¯æ­£è¦åˆ†å¸ƒã¨ã—ã¦è¡¨ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€æ¬¡å¼ã®ã‚ˆã†ã«æ­£è¦åˆ†å¸ƒã¨ã—ã¦ãƒ¢ãƒ‡ãƒ«åŒ–ã™ã‚‹ã€‚

$$
\begin{align}
\hat{x}_{t-1}

&=\operatorname{NeuralNet}\left(x_{t}, t ; \boldsymbol{\theta}\right)\tag{36} \\

p_{\theta}\left(x_{t-1} \mid x_{t}\right)

&=\mathcal{N}\left(x_{t-1} ; \hat{x}_{t-1}, \sigma_{q}^{2}(t) \mathbf{I}\right)\tag{37}
\end{align}
$$

---
# $ELBO$ã®è¿‘ä¼¼ -8
$p_{\theta}\left(x_{t-1} \mid x_{t}\right)$ ã®å¹³å‡ã¹ã‚¯ãƒˆãƒ«ã¯ã€ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã‚ˆã£ã¦æ±‚ã‚ã‚‹ã€‚
ãã—ã¦ $p_\theta\left(x_{t-1} \mid x_{t}\right)$ ã®å…±åˆ†æ•£è¡Œåˆ—ã¯ã€ $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã¨åŒã˜å€¤ $\Big( \sigma_{q}^{2}(t) \mathbf{I} \Big)$ã«è¨­å®šã™ã‚‹ã€‚ã“ã“ã§ã€ã“ã‚Œä»¥é™ã¯ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ $\mu_{\theta}\left(x_{t}, t\right)$ ã¨ç°¡ç•¥åŒ–ã—ã¦è¡¨ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€$(37)$ å¼ã‚’æ¬¡å¼ã€

$$
\begin{align}
p_{\theta}\left(x_{t-1} \mid x_{t}\right)=\mathcal{N}\left(x_{t-1} ; \mu_{\theta}\left(x_{t}, t\right), \sigma_{q}^{2}(t) \mathbf{I}\right)\tag{38}
\end{align}
$$

ãŒæˆç«‹ã™ã‚‹ã€‚

---
# [è£œè¶³] å‰ã‚¹ãƒ©ã‚¤ãƒ‰ã§$p_\theta\left(x_{t-1} \mid x_{t}\right)$ ã®å…±åˆ†æ•£è¡Œåˆ—ã‚’ $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã¨ã™ã‚‹ç†ç”±

## **[è§£ç­”]**
$KL$ ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ ${\int q\left(x_{t-1} \mid x_{t}, x_{0}\right) \log \frac{q\left(x_{t-1} \mid x_{t}, x_{0}\right)}{p_{\theta}\left(x_{t-1} \mid x_{t}\right)} d x_{t-1}}$ ã«ãŒæœ€å°å€¤ $(=0)$ ã‚’ã¨ã‚‹ãŸã‚ã€‚

ç›®çš„é–¢æ•°ã® $J_{1}$ ã¯**ãƒã‚¤ãƒŠã‚¹ã®** $KL$ ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã§ã‚ã‚Šã€$J_{1}$ ã¯ $ELBO$ ã§ã‚ã‚‹ã€‚$ELBO$ ã¯ã€€å°¤åº¦ $p_{\boldsymbol{\theta}}\left(\boldsymbol{x}_{t-1} \mid x_{t}\right)$ ã®ä¸‹ç•Œã§ã‚ã‚Šã€ã“ã‚Œã‚’æœ€å¤§åŒ–ã™ã‚‹ã¨ã€å¿…ç„¶çš„ã«ï¼ˆå…¥åŠ›ç”»åƒã‹ã‚‰æ½œåœ¨å¤‰æ•°ã‚’å¾—ã‚‹ãŸã‚ã®ï¼‰å°¤åº¦é–¢æ•°ã‚’æœ€å¤§åŒ–ã™ã‚‹ã€

**ã¤ã¾ã‚Šã€$KL$ ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã®æœ€å°åŒ–ã¯ã€å…¥åŠ›ç”»åƒã®è¡¨ç¾ã‚’å¾—ã‚‹ãŸã‚ã®å°¤åº¦æœ€å¤§åŒ–ã‚’æ„å‘³ã™ã‚‹ã€‚**

---
# $ELBO$ã®è¿‘ä¼¼ -9
æ¬¡ã« $KL$ ã‚¿ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã®è¨ˆç®—ã«ã¤ã„ã¦ã€ä»Šå›ã¯ $2$ ã¤ã®æ­£è¦åˆ†å¸ƒã® $KL$ ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã§ã‚ã‚‹ãŸã‚ã€ã“ã‚Œã¯æ¬¡å¼ã®ã¨ãŠã‚Šè§£æçš„ã«æ±‚ã‚ã‚‹ã“ã¨ãŒå¯èƒ½ã€‚

$$
\begin{align}
D_{\mathrm{KL}}\left(q\left(x_{t-1} \mid x_{t}, x_{0}\right) \| p_{\theta}\left(x_{t-1} \mid x_{t}\right)\right)=\frac{1}{2 \sigma_{q}^{2}(t)}\left\|\mu_{\theta}\left(x_{t}, t\right)-\mu_{q}\left(x_{t}, x_{0}\right)\right\|^{2} \quad\quad(39)
\end{align}
$$

---
# $(39)$ å¼ã®å°å‡º
$KL$ ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã¯å®šç¾©ã‚ˆã‚Šã€

$$
\begin{align}
D_{\mathrm{KL}}\left(q(x) \mid p(x)\right) = \int_{-\infty}^{\infty} p(x) \log \frac{p(x)}{q(x)}  dx \tag{40}
\end{align}
$$

ã¨ãªã‚‹ã€‚
ã“ã“ã§ã€$p(x)$, ãŠã‚ˆã³ $q(x)$ ã®ä¸¡æ–¹ã®ç¢ºç‡å¯†åº¦é–¢æ•°ãŒæ­£è¦åˆ†å¸ƒãªã®ã§ã€è¨ˆç®—ã‚’æ¬¡å¼ã®ã‚ˆã†ã«ç°¡ç•¥åŒ–ï¼ˆãƒ†ã‚­ã‚¹ãƒˆp. 161 å‚ç…§ã€äºŒã¤ã®ç¢ºç‡å¯†åº¦é–¢æ•°ã‚’è¿‘ã¥ã‘ã‚‹ãŸã‚ã€$1$ ã¨ãªã‚‹ï¼‰ã€‚

$$
\begin{align}
D_{\mathrm{KL}}\left(q(x) \mid p(x)\right)

= -\frac{1}{2} \left( 1 + \log
\underbrace{\frac{\sigma_q^2}{\sigma_q^2}}_{1} - \frac{(\mu_q - \mu_p)^2}{\sigma_q^2} - \underbrace{\frac{\sigma_q^2}{\sigma_q^2}}_{1} \right)  \tag{41}
\end{align}
$$

---
# $(39)$ å¼ã®å°å‡º -2
$(41)$ å¼ã«ã€$(36),(37)$ å¼ã§å®šç¾©ã—ãŸç¢ºç‡å¯†åº¦é–¢æ•°ã®æƒ…å ±ã‚’ä»£å…¥ã—ã€æ•´ç†ã™ã‚‹ã¨ã€
$$
\begin{align}
D_{\mathrm{KL}}\left(q\left(x_{t-1} \mid x_{t}, x_{0}\right) \| p_{\theta}\left(x_{t-1} \mid x_{t}\right)\right)

&= \frac{1}{2} \frac{(\mu_{q}(x_t, t) - \mu_{\theta}(x_t, x_0))^2}{\sigma_q^2(t)} \\

&= \frac{1}{2 \sigma_{q}^{2}(t)}\left\|\mu_{\theta}\left(x_{t}, t\right)-\mu_{q}\left(x_{t}, x_{0}\right)\right\|^{2} \quad\quad(39)
\end{align}
$$

ã¨ãªã‚‹ã€‚

---
# $ELBO$ã®è¿‘ä¼¼ -10
ã‚ˆã£ã¦ã€æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®ç›®çš„é–¢æ•°ã¯æ¬¡å¼ã¨ãªã‚‹ã€‚
$$
\begin{align}
J(\theta)

= -T \mathbb{E}_{u(t)}\left[\mathbb{E}_{q\left(x_{t} \mid x_{0}\right)}\left[\frac{1}{2 \sigma_{q}^{2}(t)}\left\|\mu_{\theta}\left(x_{t}, t\right)-\mu_{q}\left(x_{t}, x_{0}\right)\right\|^{2}\right]\right] \tag{42}
\end{align}
$$

æå¤±é–¢æ•°ã¯ç›®çš„é–¢æ•°ã«ãƒã‚¤ãƒŠã‚¹ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§æ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚
ã¾ãŸã€æå¤±é–¢æ•°ã‚’å®šç‰§ã™ã‚‹ã“ã¨ã¯ã€ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã®å­¦ç¿’ç‡ã®è¨­å®šã§èª¿æ•´å¯èƒ½ã€‚
ãã“ã§ä¸Šã®å¼ã‚’ - $\frac{2}{T}$ å€ã—ãŸå€¤ã‚’æå¤±é–¢æ•°ã«è¨­å®šã™ã‚‹ã¨ã€

$$
\begin{align}
\operatorname{LOSS}\left(x_{0} ; \theta\right)

= \mathbb{E}_{u(t)}\left[\mathbb{E}_{q\left(x_{t} \mid x_{0}\right)}\left[\frac{1}{\sigma_{q}^{2}(t)}\left\|\mu_{\theta}\left(x_{t}, t\right)-\mu_{q}\left(x_{t}, x_{0}\right)\right\|^{2}\right]\right] \tag{43}
\end{align}
$$

ä»¥ä¸ŠãŒæå¤±é–¢æ•°ã®è¨ˆç®—æ–¹æ³•ã§ã‚ã‚‹ã€‚

---
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã«ãŠã‘ã‚‹æå¤±é–¢æ•°
ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ï¼ˆã‚µãƒ³ãƒ–ãƒ«ã‚µã‚¤ã‚ºã‚’ 1 ã¨ã™ã‚‹ï¼‰ã‚’ä½¿ã†ã¨ã€æå¤±é–¢æ•°ã¯æ¬¡ã®ã‚ˆã†ã«æ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚

<br>

$$
\begin{align}
t & \sim U\{1, T\} \tag{44}\\

x_{t} & \sim q\left(x_{t} \mid x_{0}\right) \tag{45}\\

\operatorname{LOSS}\left(x_{0} ; \theta\right) & =\frac{1}{\sigma_{q}^{2}(t)}\left\|\mu_{\theta}\left(x_{t}, t\right)-\mu_{q}\left(x_{t}, x_{0}\right)\right\|^{2}\tag{46}
\end{align}
$$

---
# $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®å°å‡º

æœ€å¾Œã«ã€ $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®å°å‡ºã‚’è¡Œã†ã€‚ $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã¯ã¹ã‚¤ã‚¹ã®å®šç†ã‚ˆã‚Š
æ¬¡å¼ãŒæˆç«‹ã™ã‚‹ã€‚

$$
\begin{align}
q\left(x_{t-1} \mid x_{t}, x_{0}\right)=\frac{q\left(x_{t} \mid x_{t-1}, x_{0}\right) q\left(x_{t-1} \mid x_{0}\right)}{q\left(x_{t} \mid x_{0}\right)}\tag{47}
\end{align}
$$

ã“ã“ã§ãƒãƒ«ã‚³ãƒ•æ€§ã«ã‚ˆã‚Š $q\left({x}_{t} \mid {x}_{t-1}, {x}_{0}\right)=q\left({x}_{t} \mid {x}_{t-1}\right)$ ãŒæˆç«‹ã™ã‚‹ã€‚ã‚ˆã£ã¦ã€ $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã¯æ¬¡å¼ã§è¡¨ã•ã‚Œã‚‹ã€‚

$$
\begin{align}
q\left(x_{t-1} \mid x_{t}, x_{0}\right)=\frac{q\left(x_{t} \mid x_{t-1}\right) q\left(x_{t-1} \mid x_{0}\right)}{q\left(x_{t} \mid x_{0}\right)}\tag{48}
\end{align}
$$

---
# $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®å°å‡º -2
ã•ã¦ã€æ‹¡æ•£éç¨‹ã«é–¢ã™ã‚‹ç¢ºç‡åˆ†å¸ƒã«ã¤ã„ã¦ã€ã“ã‚Œã¾ã§å¾—ãŸå¼ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

$$
\begin{align}
q\left(x_{t} \mid x_{t-1}\right) 

& =\mathcal{N}\left(x_{t} ; \sqrt{\alpha_{t}} x_{t-1},\left(1-\alpha_{t}\right) \mathbf{I}\right) \tag{49} \\

q\left(x_{t} \mid x_{0}\right) & =\mathcal{N}\left(x_{t} ; \sqrt{\bar{\alpha_{t}}} x_{0},\left(1-\bar{\alpha}_{t}\right) \mathbf{I}\right) \tag{50}
\end{align}
$$

ã“ã‚Œã‚ˆã‚Š $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã¯æ¬¡å¼ã®ã‚ˆã†ã«å±•é–‹å¯èƒ½ã€‚

$$
\begin{align}
q\left(x_{t-1} \mid x_{t}, x_{0}\right) & =\frac{q\left(x_{t} \mid x_{t-1}\right) q\left(x_{t-1} \mid x_{0}\right)}{q\left(x_{t} \mid x_{0}\right)} \\
& =\frac{\mathcal{N}\left(x_{t} ; \sqrt{\alpha_{t}} x_{t-1},\left(1-\alpha_{t}\right) \mathbf{I}\right) \mathcal{N}\left(x_{t-1} ; \sqrt{\alpha_{t-1}} x_{0},\left(1-\bar{\alpha}_{t-1}\right) \mathbf{I}\right)}{\mathcal{N}\left(\boldsymbol{x}_{t} ; \sqrt{\bar{\alpha}_{t}} x_{0},\left(1-\bar{\alpha}_{t}\right) \mathbf{I}\right)} \quad(51)
\end{align}
$$

---
# $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®å°å‡º -3
$(51)$ å¼ã®ã¨ãŠã‚Šã€ 3 ã¤ã®æ­£è¦åˆ†å¸ƒã®ç©ã¨é™¤ç®—ã«ã‚ˆã£ã¦è¡¨ã•ã‚Œã‚‹ã€‚
ãã—ã¦ã€çµæœçš„ã«å¾—ã‚‰ã‚Œã‚‹ $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã‚‚ã¾ãŸæ­£è¦åˆ†å¸ƒã¨ãªã‚‹ã€‚

## $q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}, \boldsymbol{x}_{0}\right)$ ã‹ã€Œã©ã®ã‚ˆã†ãªæ­£è¦åˆ†å¸ƒã«ãªã‚‹ã‹ã€ã‚’è¨ˆç®—

ã“ã®ã‚ˆã†ãªå ´åˆã¯ã€æ­£è¦åˆ†å¸ƒã®æŒ‡æ•°éƒ¨åˆ†ã«æ³¨ç›®ã™ã‚‹ã“ã¨ã§ã€åŠ¹ç‡çš„ã«å¼å±•é–‹ãŒå¯èƒ½ã€‚
å…·ä½“çš„ã«ã€ $\mathcal{N}\left(x_{t} ; \sqrt{\alpha_{t}} x_{t-1},\left(1-\alpha_{t}\right) \mathbf{I}\right)$ ã®æŒ‡æ•°éƒ¨åˆ†ã¯æ¬¡ã‚¹ãƒ©ã‚¤ãƒ‰ã§è¡¨ã•ã‚Œã‚‹ã€‚

---
# $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®å°å‡º -4
$$
\begin{align}
&\mathcal{N}\left(x_{t} ; \sqrt{\alpha_{t}} x_{t-1},\left(1-\alpha_{t}\right) \mathbf{I}\right) \\

&\varpropto \exp \left\{-\frac{1}{2}\left(x_{t}-\sqrt{\alpha_{t}} x_{t-1}\right)^{\top}\left(\left(1-\alpha_{t}\right) \mathbf{I}\right)^{-1}\left(x_{t}-\sqrt{\alpha_{t}} x_{t-1}\right)\right\} \\

&=  \exp \left\{-\frac{1}{2}\left(x_{t}-\sqrt{\alpha_{t}} x_{t-1}\right)^{\top}\left(\frac{1}{1-\alpha_{t}} \mathbf{I}\right)\left(x_{t}-\sqrt{\alpha_{t}} x_{t-1}\right)\right\} \\

&=  \exp \left(-\frac{1}{2} \frac{\left\|x_{t}-\sqrt{\alpha_{t}} x_{t-1}\right\|^{2}}{1-\alpha_{t}}\right)
\tag{52}
\end{align}
$$

â€» " **$\varpropto$** "ã¯ã€Œæ¯”ä¾‹ã™ã‚‹ã€ã‚’è¡¨ã™è¨˜å·ã€‚

---
# $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®å°å‡º -5
ä»¥ä¸Šã®ç‚¹ã‚’è¸ã¾ãˆã¦ã€ $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®æŒ‡æ•°éƒ¨åˆ†ã«ç€ç›®ã™ã‚‹ã¨æ¬¡ã®å¼å±•é–‹ãŒã§ãã‚‹ã€‚

$$
\begin{align}
&q\left(x_{t-1} \mid x_{t}, x_{0}\right) \\

&\varpropto \exp\left(-\frac{1}{2}\left(\frac{\left\|x_{t}-\sqrt{\alpha_{t}} x_{t-1}\right\|^{2}}{1-\alpha_{t}}+\frac{\left\|x_{t-1}-\sqrt{\alpha_{t-1}} x_{0}\right\|^{2}}{1-\bar{\alpha}_{t-1}}

-\frac{\left\|x_{t}-\sqrt{\bar{\alpha}_{t}} x_{0}\right\|^{2}}{1-\bar{\alpha}_{t}}\right)\right) \\

&=\exp \left(-\frac{1}{2}\left(\frac{\left\|x_{t}\right\|^{2}-2 \sqrt{\alpha_{t}} x_{t} \cdot x_{t-1}+\alpha_{t}\left\|x_{t-1}\right\|^{2}}{1-\alpha_{t}}\right.\right. \\

& \quad\quad +\frac{\left\|x_{t-1}\right\|^{2}-2 \sqrt{\bar{\alpha}_{t-1}} x_{0} \cdot x_{t-1}+\bar{\alpha}_{t-1}\left\|x_{0}\right\|^{2}}{1-\bar{\alpha}_{t-1}} \left.\left. -\frac{\left\|x_{t}-\sqrt{\bar{\alpha}_{t}} x_{0}\right\|^{2}}{1-\bar{\alpha}_{t}}\right)\right) \\

&=\exp \left(-\frac{1}{2}\left(\left(\frac{\alpha_{t}}{1-\alpha_{t}}+\frac{1}{1-\bar{\alpha}_{t-1}}\right)\left\|x_{t-1}\right\|^{2}\right.\right. 

-\left(\frac{2 \sqrt{\alpha_{t}}}{1-\alpha_{t}} x_{t}+\frac{2 \sqrt{\alpha_{t-1}}}{1-\bar{\alpha}_{t-1}} x_{0}\right) \cdot x_{t-1} \left.\left.+C\left(x_{t}, x_{0}\right)\right)\right) \quad\quad(54)
\end{align}
$$

---
# $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®å°å‡º -5
$q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã¯ $x_{t-1}$ ã®æ¡ä»¶ä»˜ãç¢ºç‡åˆ†å¸ƒã§ã‚ã‚‹ã€‚
ã“ã“ã§ $C\left(x_{t}, x_{0}\right)$ ã¯ $x_{t-1}$ ã« é–¢ä¿‚ã—ãªã„é …ã‚’è¡¨ã™ã€‚ç¶šã„ã¦ã€$(54)$ å¼ã‚’
<br>
$$
\begin{align}
\exp \left(-\frac{1}{2} \frac{\left\|x_{t-1}-\mu_{q}\left(x_{t}, x_{0}\right)\right\|^{2}}{\sigma_{q}^{2}(t)}\right)
\tag{55}
\end{align}
$$

<br>

ã¨ã„ã†å½¢ã«å¤‰å½¢ã™ã‚‹ã“ã¨ã§ã€å¹³å‡ãƒ™ã‚¯ãƒˆãƒ« $\mu_{q}\left(x_{t}, x_{0}\right)$ ã¨åˆ†æ•£ $\sigma_{q}^{2}(t)$ ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã‚‹ãŸã‚ã€å¼å±•é–‹ã‚’è¡Œã†ã¨æ¬¡ã‚¹ãƒ©ã‚¤ãƒ‰ã®ã‚ˆã†ã«ãªã‚‹ã€‚

---
# $q\left(x_{t-1} \mid x_{t}, x_{0}\right)$ ã®å°å‡º -6
$$
\begin{align}
\sigma_{q}^{2}(t)  

&=1 /\left(\frac{\alpha_{t}}{1-\alpha_{t}}+\frac{1}{1-\bar{\alpha}_{t-1}}\right) 

= \frac{\left(1-\alpha_{t}\right)\left(1-\bar{\alpha}_{t-1}\right)}{\left(1-\bar{\alpha}_{t-1}\right) \alpha_{t}+1-\alpha_{t}} 

= \frac{\left(1-\alpha_{t}\right)\left(1-\bar{\alpha}_{t-1}\right)}{1-\bar{\alpha}_{t}} \\


\mu_{q}\left(x_{t}, x_{0}\right)

&= \left(\frac{\sqrt{\alpha_{t}}}{1-\alpha_{t}} x_{t}+\frac{\sqrt{\alpha_{t-1}}}{1-\bar{\alpha}_{t-1}} x_{0}\right) /\left(\frac{\alpha_{t}}{1-\alpha_{t}}+\frac{1}{1-\bar{\alpha}_{t-1}}\right) \\

&= \left(\frac{\sqrt{\alpha_{t}}}{1-\alpha_{t}} x_{t}+\frac{\sqrt{\bar{\alpha}_{t-1}}}{1-\bar{\alpha}_{t-1}} x_{0}\right) / \frac{1-\bar{\alpha}_{t}}{\left(1-\alpha_{t}\right)\left(1-\bar{\alpha}_{t-1}\right)} \\

&= \frac{\sqrt{\alpha_{t}}\left(1-\bar{\alpha}_{t-1}\right) x_{t}+\sqrt{\alpha_{t-1}}\left(1-\alpha_{t}\right) x_{0}}{1-\bar{\alpha}_{t}} \quad\quad(56)
\end{align}
$$

ã“ã‚Œã‚ˆã‚Šæ¬¡å¼ã‚’å¾—ã‚‹ã“ã¨ãŒã§ããŸã€‚

$$
\begin{align}
q\left(\boldsymbol{x}_{t-1} \mid \boldsymbol{x}_{t}, \boldsymbol{x}_{0}\right) 

=\mathcal{N}(x_{t-1} ; \underbrace{\frac{\sqrt{\alpha_{t}}\left(1-\bar{\alpha}_{t-1}\right) x_{t}+\sqrt{\bar{\alpha}_{t-1}}\left(1-\alpha_{t}\right) x_{0}}{1-\bar{\alpha}_{t}}}_{\mu_{q}\left(x_{t}, x_{0}\right)}, \underbrace{\frac{\left(1-\alpha_{t}\right)\left(1-\bar{\alpha}_{t-1}\right)}{1-\bar{\alpha}_{t}}}_{\sigma_{q}^{2}(t)} \mathbf{I}) 
\quad(57)
\end{align}
$$

---
<br>
<br>
<br>
<br>
<br>
<br>
<br>

# AppendiXï¼ˆè¿½åŠ èª¬æ˜ï¼‰

---
# ï¼ˆã“ã‚Œã¾ã§å­¦ç¿’ã—ãŸï¼‰æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
1. Repeat.
2. $\quad x_{0}$ ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šãƒ©ãƒ³ãƒ€ãƒ ã«å–å¾—
3. $\quad t \sim U\{1, T\} \quad$ (ä¸€æ§˜åˆ†å¸ƒã‚ˆã‚Šæ•´æ•° $t$ ã‚’ç”Ÿæˆ)
4. $\quad \varepsilon \sim \mathcal{N}(\mathbf{0}, \mathbf{I})$
5. $\quad x_{t}=\sqrt{\bar{\alpha}_{t}} x_{0}+\sqrt{1-\bar{\alpha}_{t}} \varepsilon \quad\left(q\left(x_{t} \mid x_{0}\right)\right.$ ã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«
6. $\quad \mu_{q}\left(x_{t}, x_{0}\right)=\frac{\sqrt{\alpha_{t}}\left(1-\bar{\alpha}_{t-1}\right) x_{t}+\sqrt{\bar{\alpha}_{t-1}}\left(1-\alpha_{t}\right) x_{0}}{1-\bar{\alpha}_{t}}$
7. $\quad \sigma_{q}^{2}(t)=\frac{\left(1-\alpha_{t}\right)\left(1-\bar{\alpha}_{t-1}\right)}{1-\bar{\alpha}_{t}}$
8. $\quad \operatorname{LOSS}\left(x_{0} ; \theta\right)=\frac{1}{\sigma_{q}^{2}(t)} \| \mu_{\theta}\left(x_{t}, t\right)-\mu_{q}\left(x_{t}, x_0\right) \|^2$
9. $\quad \frac{\partial}{\partial \theta}\operatorname{LOSS}\left(x_{0} ; \theta\right)$ ã‚’æ±‚ã‚ã€å‹¾é…æ³•ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°

---
# ï¼ˆã“ã‚Œã¾ã§å­¦ç¿’ã—ãŸï¼‰æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  -2

---
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
## å…ƒãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
$(56)$ å¼ã‚ˆã‚Šã€

$$
\begin{align}
\mu_{q}\left(x_{t}, x_{0}\right)

= \frac{\sqrt{\alpha_{t}}\left(1-\bar{\alpha}_{t-1}\right) x_{t}+\sqrt{\alpha_{t-1}}\left(1-\alpha_{t}\right) \color{red}x_{0}}{1-\bar{\alpha}_{t}} \quad\quad(56)
\end{align}
$$

ã¾ãŸã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€å´ã‚’ $\mu_{q}\left(x_{t}, x_{0}\right)$ ã«å¯¾å¿œã•ã›ã‚‹ã¨æ¬¡å¼ã€

$$
\begin{align}
\mu_{\theta}\left(x_{t}, t\right)

= \frac{\sqrt{\alpha_{t}}\left(1-\bar{\alpha}_{t-1}\right) x_{t}+\sqrt{\alpha_{t-1}}\left(1-\alpha_{t}\right) \color{red}\hat{x}_{\theta}(x_t,t)}{1-\bar{\alpha}_{t}} \quad\quad(58)
\end{align}
$$

ãŒæˆç«‹ã™ã‚‹ã€‚

----
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  -2
$(56), (58)$  å¼ãŒæˆç«‹ã™ã‚‹ã¨ãã€$KL$ ãƒ€ã‚¤ãƒãƒ¼ã‚¸ã‚§ãƒ³ã‚¹ã¯ $(39)$ å¼ã«ä»£å…¥ã™ã‚‹å½¢ã§æ¬¡å¼ã€
$$
\begin{align}
&D_{\mathrm{KL}}\left(q\left(x_{t-1} \mid x_{t}, x_{0}\right) \| p_{\theta}\left(x_{t-1} \mid x_{t}\right)\right) \\

&=\frac{1}{2 \sigma_{q}^{2}(t)}\left\|\mu_{\theta}\left(x_{t}, t\right)-\mu_{q}\left(x_{t}, x_{0}\right)\right\|^{2} \quad\quad(39) \\

&= \frac{1}{2 \sigma_{q}^{2}(t)}\left( \frac{\sqrt{\alpha_{t-1}}\left(1-\alpha_{t}\right)}{1-\bar{\alpha}_{t}} \right)^2\left\|\hat{x}_{\theta}(x_t,t) - x_{0} \right\|^{2} 
\tag{59}
\end{align}
$$

ã¨ãªã‚‹ã€‚

---
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  -3

---
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  -4
## ãƒã‚¤ã‚ºã‚’äºˆæ¸¬ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
$(50)$ å¼ã«ã¤ã„ã¦è€ƒãˆã‚‹ã€‚

$$
\begin{align}
q\left(\boldsymbol{x}_t \mid \boldsymbol{x}_0\right)=\mathcal{N}\left(\boldsymbol{x}_t ; \sqrt{\bar{\alpha}_t} \boldsymbol{x}_0,\left(1-\bar{\alpha}_t\right) \mathbf{I}\right)
\tag{50}
\end{align}
$$

$q\left(x_t \mid x_0\right)$ ã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«ã¯ã€å†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒˆãƒªãƒƒã‚¯ã«ã‚ˆã£ã¦ã€æ¬¡å¼ã§è¡¨ã•ã‚Œã‚‹ã€‚

$$
\begin{align}
\varepsilon & \sim \mathcal{N}(\mathbf{0}, \mathbf{I}) \\
x_t & =\sqrt{\bar{\alpha}_t} x_0+\sqrt{1-\bar{\alpha}_t }\varepsilon
\tag{60}
\end{align}
$$

---
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  -5
$(60)$ å¼ã‚’ç­‰å¼å¤‰å½¢ã™ã‚‹ã¨ã€æ¬¡å¼ãŒæˆç«‹ã™ã‚‹ã€‚

$$
\begin{align}
x_0

=\frac{x_t-\sqrt{1-\bar{\alpha}_t} \varepsilon}{\sqrt{\bar{\alpha}_t}}
\tag{61}
\end{align}
$$

$(61)$ å¼ã‚’ $(56)$ å¼ã«ä»£å…¥ã—ã¦å¼å±•é–‹ã™ã‚‹ã¨ã€

$$
\begin{align}
\mu_q\left(x_t, x_0\right) 

& =\frac{\sqrt{\alpha_t}\left(1-\bar{\alpha}_{t-1}\right) x_t+\sqrt{\alpha_{t-1}}\left(1-\alpha_t\right) x_0}{1-\bar{\alpha}_t} \quad\quad(56)\\

&=\frac{\sqrt{\alpha_t}\left(1-\bar{\alpha}_{t-1}\right) x_t+\sqrt{\alpha_{t-1}}\left(1-\alpha_t\right) \frac{x_t-\sqrt{1-\bar{\alpha}_t} \varepsilon}{\sqrt{\bar{\alpha}_{t}}}}{1-\bar{\alpha}_t}\\

&=\frac{ \sqrt{\alpha_t\bar{\alpha}_t} \left(1-\bar{\alpha}_{t-1}\right) x_t + \sqrt{\alpha_{t-1}} \left(1-\alpha_t\right) x_t - \sqrt{\alpha_{t-1}(1-\bar{\alpha}_t)} \left(1-\alpha_t\right) \varepsilon }{(1-\bar{\alpha}_t)\sqrt{\bar{\alpha}_{t}}}
\end{align}
$$

---
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  -6
(ç¶šã)
$$
\begin{align}
&=\frac{1}{\sqrt{\bar{\alpha}_{t}}}\left[\frac{ \sqrt{\alpha_t\bar{\alpha}_t} \left(1-\bar{\alpha}_{t-1}\right) + \sqrt{\alpha_{t-1}} \left(1-\alpha_t\right) }{(1-\bar{\alpha}_t)}x_t -\frac{\sqrt{\alpha_{t-1}}\left(1-\alpha_t\right)}{\sqrt{1-\bar{\alpha}_t}}\varepsilon \right] \quad(62)
\end{align}
$$

$\bar{\alpha}_t$ ã¯ $\alpha_{t} \alpha_{t-1} \cdots \alpha_{1}$ ã¨å®šç¾©ã—ãŸã®ã§ã€$\bar{\alpha}_t = \alpha_t\bar{\alpha}_{t-1}$ ã¨ãªã‚‹ã€‚ã‚ˆã£ã¦ã€

$$
\begin{align}
&\frac{\sqrt{\bar{\alpha}_{t-1}}}{\sqrt{\bar{\alpha}_{t}}}

\left[\frac{ \alpha_t \left(1-\bar{\alpha}_{t-1}\right) + \frac{1}{\sqrt{\bar{\alpha}_{t-2}}}\left(1-\alpha_t\right) }{(1-\bar{\alpha}_t)}x_t  - \frac{\frac{1}{\sqrt{\bar{\alpha}_{t-2}}}\left(1-\alpha_t\right)}{\sqrt{1-\bar{\alpha}_t}}\varepsilon \right]\\

&=\frac{1}{\sqrt{\alpha_{t}}}

\left[\frac{ \alpha_t \left(1-\bar{\alpha}_{t-1}\right) + \frac{1}{\sqrt{\bar{\alpha}_{t-2}}}\left(1-\alpha_t\right) }{(1-\bar{\alpha}_t)}x_t  - \frac{\frac{1}{\sqrt{\bar{\alpha}_{t-2}}}\left(1-\alpha_t\right)}{\sqrt{1-\bar{\alpha}_t}}\varepsilon \right] \quad(63)
\end{align}
$$

---
# æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  -7
ã™ã¿ã¾ã›ã‚“ã€ã“ã‚Œä»¥ä¸Šã¯åˆ†ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸğŸ˜¢
ã©ãªãŸã‹è©³ã—ã„æ–¹ã„ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚

æœ€çµ‚çš„ã«æ¬¡å¼ã«ãªã‚Šã¾ã™ã€‚

$$
\begin{align}
& =\frac{1}{\sqrt{\alpha_t}}\left(x_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}} \varepsilon\right)
\tag{66}
\end{align}
$$

---

---
\( t \)
\#â—‹ã‚“ãŸã¨ã„ã†ã“ã¨ã¦ã™ã€‚
$$
\operatorname{LOSS}\left(x_{0} ; \theta\right)=\left\|\varepsilon_{\theta}\left(x_{t}, t\right)-\varepsilon\right\|^{2}
$$

ã“ã®ã‚·ãƒ³ãƒ•ãƒ«ãªæŠ¥å¤±é–ƒæ•°ã«ã‚ˆã£ã¦æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ãŒå­¦ç¿’ã§ãã¾ã™ã€‚ã“ã®æŒ¸ï¼‰å¤ªä¸´å‚ãƒ«ã‚³ãƒªã‚¹ãƒ ã¯ã€å›¬ä¼¼ã‚³ãƒ¼ãƒ‰ã§æ¬¡ã®ã‚ˆã†ã«è¡¨ã•ã‚Œã¾ã™ã€‚

æ¡©æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆãƒã‚¤ã‚ºäºˆæ¸¬ç‰ˆï¼‰

---
# ï¼ˆãƒã‚¤ã‚ºäºˆæ¸¬å‹ã®ï¼‰æ‹¡æ•£ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
1: Repeat:
2: $x_{0}$ ã‚’å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šãƒ©ãƒ³ãƒ€ãƒ ã«å–å¾—
3: $\quad t \sim U\{1, T\} \quad$ (ä¸€æ§˜åˆ†å¸ƒã‚ˆã‚Šæ•´æ•° $t$ ã‚’ç”Ÿæˆ)
4: $\quad \varepsilon \sim \mathcal{N}(0, \mathrm{I})$
5: $\quad x_{t}=\sqrt{\bar{\alpha}_{t}} x_{0}+\sqrt{1-\bar{\alpha}_{t} \varepsilon}$
6: $\quad \operatorname{LOSS}\left(x_{0} ; \theta\right)=\left\|\varepsilon_{\theta}\left(x_{t}, t\right)-\varepsilon\right\|^{2}$
7: $\quad \frac{\partial}{\partial \theta} \operatorname{LOSS}\left(\boldsymbol{x}_{0} ; \boldsymbol{\theta}\right)$ ã‚’æ±‚ã‚ã€å‹¾é…æ³•ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°
